<%= javascript_include_tag "precompile/store_and_cart" %>
<%= javascript_include_tag "precompile/cart_submit" %>

<div class="row">
  <div class="col-xs-12">

    <div class="centeredProducts">
      
      <div class="alert alert-warning" id="serverError" style="display:none;">
        There was a server error.
      </div>

      <%= render "/partials/flash_message" %>

      <div class="row">
        <div class="col-xs-12">
          <div class="text-center">
            <h3 class="content-heading">
              My Cart - <%= @total_lines %> Lines
            </h3>
          </div>
        </div>
      </div>

      <div class="row content-header-row">

        <div class="col-xs-6">
          <div class="row">
            <%= link_to "Back To Store", store_index_path, class: "btn btn-default content-header-btn" %>
          </div>
        </div>

        <div class="col-xs-6">
          <div class="row">
            <div class="pull-right">
              <%=
              if @total_lines > 0
                link_to "Clear My Cart", clear_cart_path, class: "btn btn-default content-header-btn", id: "clearMyCartBtn", :method => 'delete' 
              else
                link_to "Clear My Cart", clear_cart_path, class: "btn btn-default content-header-btn disabled", id: "clearMyCartBtn", :method => 'delete'  
              end
              %>
            </div>
          </div>
        </div>
        
      </div>

      <%
      # Remote: This will make the form submit via ajax (Through unobtrusive javaScript)
      # A remote form automatically gets its authenticity token from the page's meta tag.
      %>
      <%= form_tag '/cart/submit', remote: true, id: "cartForm" %>
        <% @products.each do |product| %>
          <%=
          render "partials/forsale_product_line", {
            product: product[:record],
            product_qty: product[:cart_qty],
            subtotal: product[:subtotal],
            atStore: false
          }
          %>
        <% end %>

        <%=
        render "cart/partials/summaryRow", {
          total_items: @total_items,
          grand_total: @grand_total
        }
        %>

        <% if @total_lines > 0 %>
          <% if current_user.present? %>
            <% if @addresses.where(deleted: false).count > 0 %>
              <div class="row">
                <div class="col-xs-12 well">
                  <h3>Shipping / Billing details:</h3>
                  <%= render 'cart/partials/addressHeader' %>
                  <% @addresses.each do |a| %>
                    <% if a.deleted == false %>
                      <%= render 'cart/partials/addressRow', { address: a, user: current_user } %>
                    <% end %>
                  <% end %>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-12">
                  <div class="text-center">
                    <h3>
                      <%=
                      submit_tag "Place Order", {class: "btn btn-default cart-submit-btn"}
                      %>
                    </h3>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="row">
                <div class="col-xs-12">
                  <div class="text-center">
                    You currently have no addresses available. Please 
                    <%= link_to "create an Address", user_addresses_path(current_user) %>
                    under your account details.
                  </div>
                </div>
              </div>
            <% end %>

          <% else %>
            <div class="row">
              <div class="col-xs-12">
                <div class="text-center">
                  Please 
                  <%= link_to "Log In", login_path, class: "" %>
                  to place an order.
                </div>
              </div>
            </div>
          <% end %>
        <% end %>
        
      </form>

    </div>
  </div>
</div>